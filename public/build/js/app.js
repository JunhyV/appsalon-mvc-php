const agendarCita=document.getElementById("cita-app");let paso=1,cita={usuarioId:document.getElementById("id").value,nombre:document.getElementById("nombre").value,fecha:"",hora:"",servicios:[]};function Paginador(){const e=document.getElementById("anterior"),t=document.getElementById("siguiente");e.addEventListener("click",()=>{paso--,optimizar()}),t.addEventListener("click",()=>{paso++,optimizar()})}function Tabs(){document.querySelectorAll("[data-paso]").forEach(e=>e.addEventListener("click",e=>{paso=parseInt(e.target.dataset.paso),optimizar()}))}function mostrarSeccion(){identificador="paso-"+paso,seccion=document.getElementById(identificador);const e=document.querySelector(".cita--visible");e&&e.classList.remove("cita--visible"),seccion.classList.add("cita--visible")}function ocultarAndMarcar(){const e=document.getElementById("anterior"),t=document.getElementById("siguiente"),a=document.querySelectorAll("[data-paso]");switch(document.querySelector(".tabs--seleccionado").classList.remove("tabs--seleccionado"),a.forEach(e=>parseInt(e.dataset.paso)===paso?e.classList.add("tabs--seleccionado"):null),paso){case 1:e.classList.add("boton--invisible"),t.classList.remove("boton--invisible");break;case 2:e.classList.remove("boton--invisible"),t.classList.remove("boton--invisible");break;case 3:e.classList.remove("boton--invisible"),t.classList.add("boton--invisible"),mostrarResumen()}}function optimizar(){mostrarSeccion(),ocultarAndMarcar()}async function consultarApi(e){try{const t=await fetch(e);return await t.json()}catch(e){console.log(e)}}async function mostrarServicios(){try{(await consultarApi(location.origin+"/api/servicios")).forEach(e=>{const{id:t,nombre:a,precio:n}=e,o=document.createElement("DIV");o.classList.add("servicios__card"),o.dataset.idServicio=t,o.addEventListener("click",()=>seleccionarServicio(e));const c=document.createElement("P");c.textContent=a;const i=document.createElement("P");i.textContent=n,o.appendChild(c),o.appendChild(i),document.getElementById("servicios").appendChild(o)})}catch(e){console.log(e)}}function horaAndFecha(){const e=document.querySelector("#fecha"),t=document.querySelector("#hora");e.addEventListener("change",e=>validarFecha(e)),t.addEventListener("change",e=>validarHora(e))}function validarFecha(e){const t=new Date(e.target.value).getUTCDay(),a=document.getElementById("paso-2");0===t||6===t?(mostrarAlerta("Los fines de semana no abrimos","error",a),e.target.value=""):cita.fecha=e.target.value}function validarHora(e){const t=e.target.value.split(":"),a=document.getElementById("paso-2");parseInt(t[0])<9||parseInt(t[0])>17?(mostrarAlerta("El horario del salon es de 9:00 a 18:00","error",a),e.target.value=""):cita.hora=e.target.value}function seleccionarServicio(e,t){const a=document.querySelector(`[data-id-servicio="${e.id}"]`),n=cita.servicios.find(t=>t.id===e.id);if(n){a.classList.remove("servicios__card--selecto");const e=cita.servicios.filter(e=>e.id!==n.id);cita.servicios=e}else a.classList.add("servicios__card--selecto"),cita.servicios=[...cita.servicios,e]}function mostrarAlerta(e,t,a,n=!1){const o=document.createElement("P");o.classList.add("alerta"),o.classList.add("alerta__"+t),o.textContent=e,a.appendChild(o),n||setTimeout(()=>{o.remove()},3e3)}function mostrarResumen(){const e=document.querySelector("#resumen");if(limpiarHTML(e),Object.values(cita).includes("")||0===cita.servicios.length)return void mostrarAlerta("Los servicios o datos estan incompletos","error",e,!0);const t=document.createElement("P");t.textContent="Verifica que la información sea correcta:",e.appendChild(t);const a=document.createElement("H3");a.textContent="Resumen de servicios",e.appendChild(a),cita.servicios.forEach(t=>{const a=document.createElement("DIV"),n=document.createElement("P");n.textContent="Servicio: ";const o=document.createElement("SPAN");o.textContent=t.nombre,n.appendChild(o);const c=document.createElement("P");c.textContent="Precio: ";const i=document.createElement("SPAN");i.textContent=t.precio,c.appendChild(i);const r=document.createElement("HR");a.appendChild(n),a.appendChild(c),a.appendChild(r),e.appendChild(a)});const n=document.createElement("P");n.textContent="Nombre: ";const o=document.createElement("SPAN");o.textContent=cita.nombre,n.appendChild(o);const c=document.createElement("P");c.textContent="Fecha: ";const i=document.createElement("SPAN");i.textContent=transformarFecha(cita.fecha),c.appendChild(i);const r=document.createElement("P");r.textContent="Hora: ";const s=document.createElement("SPAN");s.textContent=cita.hora,r.appendChild(s),e.appendChild(n),e.appendChild(c),e.appendChild(r);const d=document.createElement("BUTTON");d.classList.add("boton--azul"),d.textContent="Reservar cita",d.onclick=()=>reservarCita(),e.appendChild(d)}function limpiarHTML(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function transformarFecha(e){const t=new Date(e),a=t.getMonth(),n=t.getDate()+2,o=t.getFullYear();return new Date(Date.UTC(o,a,n)).toLocaleDateString("es-MX",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}async function reservarCita(){const{usuarioId:e,fecha:t,hora:a,servicios:n}=cita,o=new FormData;o.append("usuarios_id",e),o.append("fecha",t),o.append("hora",a);const c=n.map(e=>e.id);o.append("servicios",c);const i=location.origin+"/api/cita";try{const e=await fetch(i,{method:"POST",body:o});(await e.json()).resultado&&Swal.fire({icon:"success",title:"Cita creada",text:"Tu cita ha sido reservada correctamente."}).then(setTimeout(()=>window.location.reload(),3e3))}catch(e){Swal.fire({icon:"error",title:"Error",text:"Lo sentimos, algo salió mal"}).then(window.location.reload())}}agendarCita&&document.addEventListener("DOMContentLoaded",()=>{Paginador(),Tabs(),mostrarServicios(),horaAndFecha()});